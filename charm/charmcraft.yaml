type: charm
name: release-monitor-gcloud
title: Release Monitor GCloud
summary: Monitor GCS releases, mirror artifacts to Nextcloud, and emit signed webhooks.
description: |
  Machine charm for gcs-release-monitor.
  Runs the monitor under systemd on a single unit and renders app-native YAML config.

base: ubuntu@22.04
platforms:
  amd64:
  arm64:

parts:
  charm:
    plugin: uv
    source: .
    build-snaps:
      - astral-uv

resources:
  release-monitor-wheel:
    type: file
    filename: gcs_release_monitor.whl
    description: |
      Pinned gcs-release-monitor wheel installed into charm-managed virtualenv.

requires:
  release-monitor-webhook:
    interface: release-monitor-webhook

config:
  options:
    poll-interval-seconds:
      type: int
      default: 900
      description: |
        Polling interval for release monitor loop.
        Rendered runtime key: poll_interval_seconds.
    state-dir:
      type: string
      default: /var/lib/release-monitor-gcloud/state
      description: |
        State directory passed to app config.
        Rendered runtime key: state_dir.
    temp-dir:
      type: string
      default: /var/lib/release-monitor-gcloud/tmp
      description: |
        Temporary download directory passed to app config.
        Rendered runtime key: temp_dir.
    delivery-mode:
      type: string
      default: full
      description: |
        Artifact delivery mode. full uploads to Nextcloud; webhook_only skips upload and sends webhook only.
        Rendered runtime key: delivery_mode.
        Example: webhook_only

    gcs-bucket:
      type: string
      default: ""
      description: |
        Required. GCS bucket name.
        Rendered runtime key: gcs.bucket.
    gcs-anonymous:
      type: boolean
      default: false
      description: Use anonymous GCS access.
    gcs-use-gcloud-cli:
      type: boolean
      default: false
      description: Use local gcloud CLI auth mode.
    gcs-include-prefixes:
      type: string
      default: "[]"
      description: |
        JSON array of object name prefixes.
        Rendered runtime key: gcs.include_prefixes.
        Example: '["v2.0.7/"]'
    gcs-include-suffixes:
      type: string
      default: "[]"
      description: |
        JSON array of candidate archive suffixes.
        Rendered runtime key: gcs.include_suffixes.
        Example: '[".tar.gz", ".tgz"]'
    gcs-include-content-types:
      type: string
      default: "[]"
      description: |
        JSON array of accepted MIME types.
        Rendered runtime key: gcs.include_content_types.
        Example: '["application/gzip", "application/octet-stream"]'
    gcs-service-account-secret-id:
      type: string
      default: ""
      description: |
        Secret ID containing key service_account_json.
        Used when gcs-anonymous=false and gcs-use-gcloud-cli=false.
        Rendered runtime key impact: writes gcs.credentials_file from secret content.

    nextcloud-base-url:
      type: string
      default: ""
      description: |
        Required when delivery-mode=full. Nextcloud base URL.
        Rendered runtime key: nextcloud.base_url.
    nextcloud-remote-dir:
      type: string
      default: ""
      description: |
        Required when delivery-mode=full. Remote Nextcloud root directory for uploads.
        Rendered runtime key: nextcloud.remote_dir.
        Example: EXTERNAL/FILESHARES/CLIENT_BINARIES
    nextcloud-verify-tls:
      type: boolean
      default: true
      description: Verify TLS for Nextcloud API calls.
    nextcloud-create-public-share:
      type: boolean
      default: true
      description: Create public share links for uploaded artifacts.
    nextcloud-share-expire-days:
      type: int
      default: 0
      description: Public share expiration in days; 0 omits field.
    nextcloud-share-permissions:
      type: int
      default: 1
      description: Nextcloud share permission bitmask.
    nextcloud-credentials-secret-id:
      type: string
      default: ""
      description: |
        Required when delivery-mode=full. Secret ID with username/app_password, optional share_password.
        Rendered runtime keys sourced from this secret: nextcloud.username, nextcloud.app_password, nextcloud.share_password.

    webhook-url:
      type: string
      default: ""
      description: |
        Fallback webhook URL when relation is absent.
        Rendered runtime key: webhook.url.
        Example: https://release-filter.example/v1/releases
    webhook-timeout-seconds:
      type: int
      default: 10
      description: Webhook HTTP timeout.
    webhook-verify-tls:
      type: boolean
      default: true
      description: Verify TLS for webhook endpoint.
    webhook-shared-secret-secret-id:
      type: string
      default: ""
      description: |
        Fallback secret ID containing key shared-secret.
        Used when webhook relation does not provide credentials.
        Rendered runtime key: webhook.shared_secret.

    chain-organization:
      type: string
      default: ""
      description: |
        Required. Source chain organization.
        Rendered runtime key: chain.organization.
    chain-repository:
      type: string
      default: ""
      description: |
        Required. Source chain repository.
        Rendered runtime key: chain.repository.
    chain-common-name:
      type: string
      default: ""
      description: |
        Display/common name. Empty falls back to chain-repository.
        Rendered runtime key: chain.common_name.
    chain-extra-info:
      type: string
      default: ""
      description: Optional release metadata context.
    chain-client-name:
      type: string
      default: ""
      description: Optional client name.
    chain-ids:
      type: string
      default: "[]"
      description: |
        JSON array of integer chain IDs.
        Rendered runtime key: chain.chain_ids.
        Example: '[4326]'
    chain-genesis-hashes:
      type: string
      default: "[]"
      description: |
        JSON array of genesis hashes.
        Rendered runtime key: chain.genesis_hashes.
        Example: '["0x1234..."]'

    release-defaults-urgent:
      type: boolean
      default: false
      description: Default urgent flag in webhook payload.
    release-defaults-priority:
      type: int
      default: 3
      description: Default priority in webhook payload.
    release-defaults-due-date:
      type: string
      default: P2D
      description: Default due date window (P1D, P2D, P5D).

    artifact-selection-enabled:
      type: boolean
      default: true
      description: Enable artifact extraction rules.
    artifact-selection-fallback-to-archive:
      type: boolean
      default: true
      description: Fallback to archive upload when extraction fails.
    artifact-selection-default-binary-patterns:
      type: string
      default: "[]"
      description: |
        JSON array of default binary extraction patterns.
        Rendered runtime key: artifact_selection.default_binary_patterns.
        Example: '["rpc-node-*", "*/rpc-node-*"]'
    artifact-selection-default-genesis-patterns:
      type: string
      default: "[]"
      description: |
        JSON array of default genesis extraction patterns.
        Rendered runtime key: artifact_selection.default_genesis_patterns.
        Example: '["mainnet/genesis.json", "*/mainnet/genesis.json"]'
    artifact-selection-rules:
      type: string
      default: "[]"
      description: |
        JSON array of artifact selection rule objects.
        Rendered runtime key: artifact_selection.rules.
        Example: '[{"organization":"megaeth","repository":"megaeth-rpc","binary_patterns":["rpc-node-*"],"genesis_patterns":["mainnet/genesis.json"]}]'

    log-level:
      type: string
      default: INFO
      description: CLI log level for gcs-release-monitor.

actions:
  run-once:
    description: Run a single polling cycle immediately.

  run-once-dry-run:
    description: Run one dry-run cycle (no uploads, no webhook delivery, no state mutation).

  show-effective-config:
    description: Show the effective rendered monitor configuration with secrets redacted.

  service-restart:
    description: Restart the systemd service now.
