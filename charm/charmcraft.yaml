type: charm
name: release-monitor-gcloud
title: Release Monitor GCloud
summary: Monitor GCS releases, mirror artifacts to Nextcloud, and emit signed webhooks.
description: |
  Machine charm for gcs-release-monitor.
  Runs the monitor under systemd on a single unit and renders app-native YAML config.

base: ubuntu@22.04
platforms:
  amd64:
  arm64:

parts:
  charm:
    plugin: uv
    source: .
    build-snaps:
      - astral-uv

resources:
  release-monitor-wheel:
    type: file
    filename: gcs_release_monitor.whl
    description: |
      Pinned gcs-release-monitor wheel installed into charm-managed virtualenv.

requires:
  release-monitor-webhook:
    interface: release-monitor-webhook

config:
  options:
    poll-interval-seconds:
      type: int
      default: 900
      description: Polling interval for release monitor loop.
    state-dir:
      type: string
      default: /var/lib/release-monitor-gcloud/state
      description: State directory passed to app config.
    temp-dir:
      type: string
      default: /var/lib/release-monitor-gcloud/tmp
      description: Temporary download directory passed to app config.
    delivery-mode:
      type: string
      default: full
      description: Artifact delivery mode. full uploads to Nextcloud; webhook_only skips upload and sends webhook only.

    gcs-bucket:
      type: string
      default: ""
      description: Required. GCS bucket name.
    gcs-anonymous:
      type: boolean
      default: false
      description: Use anonymous GCS access.
    gcs-use-gcloud-cli:
      type: boolean
      default: false
      description: Use local gcloud CLI auth mode.
    gcs-include-prefixes:
      type: string
      default: "[]"
      description: JSON array of object name prefixes.
    gcs-include-suffixes:
      type: string
      default: "[]"
      description: JSON array of candidate archive suffixes.
    gcs-include-content-types:
      type: string
      default: "[]"
      description: JSON array of accepted MIME types.
    gcs-service-account-secret-id:
      type: string
      default: ""
      description: Secret ID containing key service_account_json.

    nextcloud-base-url:
      type: string
      default: ""
      description: Required when delivery-mode=full. Nextcloud base URL.
    nextcloud-remote-dir:
      type: string
      default: ""
      description: Required when delivery-mode=full. Remote Nextcloud root directory for uploads.
    nextcloud-verify-tls:
      type: boolean
      default: true
      description: Verify TLS for Nextcloud API calls.
    nextcloud-create-public-share:
      type: boolean
      default: true
      description: Create public share links for uploaded artifacts.
    nextcloud-share-expire-days:
      type: int
      default: 0
      description: Public share expiration in days; 0 omits field.
    nextcloud-share-permissions:
      type: int
      default: 1
      description: Nextcloud share permission bitmask.
    nextcloud-credentials-secret-id:
      type: string
      default: ""
      description: Required when delivery-mode=full. Secret ID with username/app_password, optional share_password.

    webhook-url:
      type: string
      default: ""
      description: Fallback webhook URL when relation is absent.
    webhook-timeout-seconds:
      type: int
      default: 10
      description: Webhook HTTP timeout.
    webhook-verify-tls:
      type: boolean
      default: true
      description: Verify TLS for webhook endpoint.
    webhook-shared-secret-secret-id:
      type: string
      default: ""
      description: Fallback secret ID containing key shared-secret.

    chain-organization:
      type: string
      default: ""
      description: Required. Source chain organization.
    chain-repository:
      type: string
      default: ""
      description: Required. Source chain repository.
    chain-common-name:
      type: string
      default: ""
      description: Display/common name. Empty falls back to chain-repository.
    chain-extra-info:
      type: string
      default: ""
      description: Optional release metadata context.
    chain-client-name:
      type: string
      default: ""
      description: Optional client name.
    chain-ids:
      type: string
      default: "[]"
      description: JSON array of integer chain IDs.
    chain-genesis-hashes:
      type: string
      default: "[]"
      description: JSON array of genesis hashes.

    release-defaults-urgent:
      type: boolean
      default: false
      description: Default urgent flag in webhook payload.
    release-defaults-priority:
      type: int
      default: 3
      description: Default priority in webhook payload.
    release-defaults-due-date:
      type: string
      default: P2D
      description: Default due date window (P1D, P2D, P5D).

    artifact-selection-enabled:
      type: boolean
      default: true
      description: Enable artifact extraction rules.
    artifact-selection-fallback-to-archive:
      type: boolean
      default: true
      description: Fallback to archive upload when extraction fails.
    artifact-selection-default-binary-patterns:
      type: string
      default: "[]"
      description: JSON array of default binary extraction patterns.
    artifact-selection-default-genesis-patterns:
      type: string
      default: "[]"
      description: JSON array of default genesis extraction patterns.
    artifact-selection-rules:
      type: string
      default: "[]"
      description: JSON array of artifact selection rule objects.

    log-level:
      type: string
      default: INFO
      description: CLI log level for gcs-release-monitor.

actions:
  run-once:
    description: Run a single polling cycle immediately.

  run-once-dry-run:
    description: Run one dry-run cycle (no uploads, no webhook delivery, no state mutation).

  show-effective-config:
    description: Show the effective rendered monitor configuration with secrets redacted.

  service-restart:
    description: Restart the systemd service now.
