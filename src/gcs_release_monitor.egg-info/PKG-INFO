Metadata-Version: 2.4
Name: gcs-release-monitor
Version: 0.1.0
Summary: Poll a Google Cloud Storage bucket, mirror new artifacts to Nextcloud, and emit signed webhook release events
Requires-Python: >=3.10
Description-Content-Type: text/markdown
Requires-Dist: google-cloud-storage>=2.18.0
Requires-Dist: httpx>=0.27.0
Requires-Dist: PyYAML>=6.0.1
Provides-Extra: dev
Requires-Dist: pytest>=8.3.0; extra == "dev"

# gcs-release-monitor

Lightweight polling service for release artifacts published in a Google Cloud Storage bucket.

## What it does

1. Polls the configured GCS bucket every `poll_interval_seconds` (default 900 = 15 minutes).
2. Stores a local snapshot of object metadata (`snapshot-latest.json`).
3. Diffs current snapshot with the previous snapshot to detect new objects.
4. Filters to release artifact candidates using metadata + suffix/content-type checks.
5. Downloads each new artifact from GCS.
6. Uploads it to Nextcloud via WebDAV.
7. Optionally creates a public Nextcloud share URL.
8. Sends a signed webhook event to release-filter, so the Linear consumer can create a ticket.

The service is idempotent across restarts via `state/state.json` keyed by `object_name#generation`.

## Install

```bash
python3 -m venv .venv
. .venv/bin/activate
pip install -e .[dev]
```

## Configure

```bash
cp config/example.yaml config/local.yaml
# edit config/local.yaml
```

## Run

Single cycle:

```bash
gcs-release-monitor --config config/local.yaml --once
```

Continuous:

```bash
gcs-release-monitor --config config/local.yaml
```

## Webhook payload contract

The monitor posts JSON with these keys:

- `event_type`, `event_version`, `source`
- `chain`
- `release_meta` (`html_url`, `tag_name`)
- `release` (GCS + Nextcloud metadata)
- `result` (summary/priority fields expected by release-filter consumers)

Signature headers:

- `X-Release-Timestamp`: Unix seconds
- `X-Release-Signature`: `sha256=<hmac>` over `<timestamp>.<json_body>`

## State files

- `state/state.json`: processed object IDs and delivery metadata.
- `state/snapshot-latest.json`: latest object snapshot.
- `state/snapshot-previous.json`: previous object snapshot.
